name: Context Refresh

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  collect-context:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq dnsutils

      - name: Configure GH token for issue/pr metrics
        if: ${{ secrets.GITHUB_API_TOKEN != '' }}
        run: |
          echo "GH_TOKEN=${{ secrets.GITHUB_API_TOKEN }}" >> $GITHUB_ENV

      - name: Configure AWS credentials
        if: ${{ secrets.AWS_ACCESS_KEY_ID != '' && secrets.AWS_SECRET_ACCESS_KEY != '' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}

      - name: Configure Grafana token
        if: ${{ secrets.GRAFANA_API_TOKEN != '' && vars.GRAFANA_URL != '' }}
        run: |
          echo "GRAFANA_API_TOKEN=${{ secrets.GRAFANA_API_TOKEN }}" >> $GITHUB_ENV
          echo "GRAFANA_URL=${{ vars.GRAFANA_URL }}" >> $GITHUB_ENV

      - name: Run collectors
        env:
          GITHUB_ORG: ${{ vars.GITHUB_ORG || github.repository_owner }}
          GITHUB_REPO: ${{ vars.GITHUB_REPO || github.event.repository.name }}
        run: |
          chmod +x scripts/context/*.sh scripts/context/lib/*.sh
          args=()
          if [ -z "${AWS_ACCESS_KEY_ID:-}" ] || [ -z "${AWS_SECRET_ACCESS_KEY:-}" ]; then
            args+=("--skip-aws")
          fi
          if [ -z "${GRAFANA_API_TOKEN:-}" ] || [ -z "${GRAFANA_URL:-}" ]; then
            args+=("--skip-grafana")
          fi
          ./scripts/context/collect_all.sh "${args[@]}"

      - name: Validate snapshots
        run: |
          ./scripts/context/validate_context.sh

      - name: Commit snapshot updates
        run: |
          if git diff --quiet context-engineering/snapshots; then
            echo "No context snapshot changes"
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add context-engineering/snapshots
          git commit -m "context: refresh snapshots $(date -u +%Y-%m-%d)"
          git push
